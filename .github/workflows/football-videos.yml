# .github/workflows/football-videos.yml
name: Football Video Bot

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run without posting to Facebook'
        required: false
        default: 'false'
        type: boolean
      max_videos:
        description: 'Maximum videos to post'
        required: false
        default: '3'
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  fetch-and-post:
    runs-on: ubuntu-latest
    
    # Prevent concurrent runs
    concurrency:
      group: football-video-bot
      cancel-in-progress: false
    
    permissions:
      contents: write  # Needed to commit posted_videos.json
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üîç Validate Secrets
        run: |
          if [ -z "${{ secrets.RAPIDAPI_KEY }}" ]; then
            echo "::error::RAPIDAPI_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.FACEBOOK_PAGE_ID }}" ]; then
            echo "::error::FACEBOOK_PAGE_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.FACEBOOK_ACCESS_TOKEN }}" ]; then
            echo "::error::FACEBOOK_ACCESS_TOKEN secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"
      
      - name: üèà Run Football Video Bot
        id: run_bot
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          FACEBOOK_ACCESS_TOKEN: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          MAX_VIDEOS: ${{ github.event.inputs.max_videos || '3' }}
        run: |
          python -m src.main
      
      - name: üíæ Commit Updated Video Tracker
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet data/posted_videos.json; then
            echo "No changes to commit"
          else
            git add data/posted_videos.json
            git commit -m "üìù Update posted videos tracker [skip ci]"
            git push
            echo "‚úÖ Updated posted_videos.json"
          fi
      
      - name: üìä Generate Summary
        if: always()
        run: |
          echo "## üèà Football Video Bot Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/run_report.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Results" >> $GITHUB_STEP_SUMMARY
            python -c "
          import json
          with open('data/run_report.json') as f:
              report = json.load(f)
          print(f\"- Videos Fetched: {report.get('fetched', 0)}\")
          print(f\"- Videos Posted: {report.get('posted', 0)}\")
          print(f\"- Duplicates Skipped: {report.get('skipped', 0)}\")
          print(f\"- Errors: {report.get('errors', 0)}\")
          " >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üö® Notify on Failure
        if: failure()
        run: |
          echo "::error::Football Video Bot failed! Check logs for details."

  # Health check job - runs daily
  health-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: fetch-and-post
    
    steps:
      - name: üè• API Health Check
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "X-RapidAPI-Key: $RAPIDAPI_KEY" \
            -H "X-RapidAPI-Host: free-football-soccer-videos.p.rapidapi.com" \
            "https://free-football-soccer-videos.p.rapidapi.com/")
          
          if [ "$response" -eq 200 ]; then
            echo "‚úÖ RapidAPI is healthy (HTTP $response)"
          else
            echo "::warning::RapidAPI returned HTTP $response"
          fi
